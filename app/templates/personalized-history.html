<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üåç G·ª£i √Ω du l·ªãch c√° nh√¢n h√≥a</title>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      background: linear-gradient(to bottom, #e0f7fa, #ffffff);
      min-height: 100vh;
      font-family: 'Inter', Arial, sans-serif;
    }
    .hero {
      background: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1350&q=80') no-repeat center center/cover;
      color: white;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
    }
    .card {
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0,0,0,0.15);
    }
    .loader {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4CAF50;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    #description {
      line-height: 1.8;
      white-space: pre-wrap;
    }
    #description strong {
      color: #2c3e50;
    }
  </style>
</head>
<body class="text-gray-800">
  <!-- Home Button -->
  <a href="/" class="home-button" style="position: fixed; top: 20px; left: 20px; z-index: 1000; background-color: #4CAF50; color: white; padding: 10px 15px; border-radius: 25px; text-decoration: none; font-weight: bold; box-shadow: 0 2px 10px rgba(0,0,0,0.2); transition: all 0.3s ease;">
    <i class="fas fa-home" style="margin-right: 5px;"></i>Trang Ch·ªß
  </a>
  
  <!-- Hero Section -->
  <section class="hero py-16 text-center">
    <h1 class="text-4xl md:text-5xl font-bold mb-4">‚ú® Kh√°m ph√° h√†nh tr√¨nh c·ªßa ri√™ng b·∫°n ‚ú®</h1>
    <p class="text-lg md:text-xl max-w-2xl mx-auto">ƒê·ªÉ ch√∫ng t√¥i mang ƒë·∫øn nh·ªØng g·ª£i √Ω du l·ªãch ƒë∆∞·ª£c thi·∫øt k·∫ø ri√™ng, ph√π h·ª£p v·ªõi t√¢m tr·∫°ng v√† gu kh√°m ph√° c·ªßa b·∫°n!</p>
  </section>

  <!-- Main Content -->
  <div class="max-w-4xl mx-auto p-6">
    <!-- Input Card -->
    <div class="card bg-white p-8 rounded-lg shadow-lg mb-8">
      <h2 class="text-2xl font-semibold mb-4">üß≥ T√πy ch·ªânh s·ªü th√≠ch c·ªßa b·∫°n</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <label for="mood" class="block text-sm font-medium text-gray-700">T√¢m tr·∫°ng c·ªßa b·∫°n</label>
          <select id="mood" class="mt-1 block w-full p-3 border rounded-md focus:ring-2 focus:ring-green-500">
            <option value="chill">Th∆∞ gi√£n</option>
            <option value="active">NƒÉng ƒë·ªông</option>
            <option value="adventure">Phi√™u l∆∞u</option>
            <option value="relaxed">B√¨nh y√™n</option>
          </select>
        </div>
        <div>
          <label for="place" class="block text-sm font-medium text-gray-700">ƒê·ªãa ƒëi·ªÉm y√™u th√≠ch</label>
          <select id="place" class="mt-1 block w-full p-3 border rounded-md focus:ring-2 focus:ring-green-500">
            <option value="river">S√¥ng n∆∞·ªõc</option>
            <option value="mountain">N√∫i ƒë·ªìi</option>
            <option value="quiet">Y√™n tƒ©nh</option>
            <option value="city">Th√†nh ph·ªë</option>
            <option value="beach">B√£i bi·ªÉn</option>
          </select>
        </div>
      </div>
      <div class="flex justify-center space-x-4">
        <button id="trainAndGenerateButton" class="bg-green-500 text-white px-6 py-2 rounded-md hover:bg-green-600 transition">üîÑ T·∫°o g·ª£i √Ω m·ªõi</button>
        <button id="saveSampleButton" class="bg-blue-500 text-white px-6 py-2 rounded-md hover:bg-blue-600 transition">üíæ L∆∞u g·ª£i √Ω n√†y</button>
      </div>
      <p class="mt-4 text-gray-600">Tr·∫°ng th√°i: <span id="status" class="font-semibold">ƒêang ch·ªù...</span></p>
      <div id="loader" class="loader mt-4 hidden"></div>
    </div>

    <!-- Recommendation Card -->
    <div class="card bg-white p-8 rounded-lg shadow-lg mb-8">
      <h2 class="text-2xl font-semibold mb-4">üß≠ G·ª£i √Ω d√†nh ri√™ng cho b·∫°n</h2>
      <p id="sampleResult" class="text-lg text-gray-700 mb-4"></p>
      <p id="description" class="text-gray-600"></p>
    </div>

    <!-- History Card -->
    <div class="card bg-white p-8 rounded-lg shadow-lg">
      <h2 class="text-2xl font-semibold mb-4">üìú L·ªãch s·ª≠ g·ª£i √Ω c·ªßa b·∫°n</h2>
      <ul id="historyList" class="list-disc list-inside text-left text-gray-700"></ul>
    </div>
  </div>

  <script>
    const statusEl = document.getElementById("status");
    const resultEl = document.getElementById("sampleResult");
    const descEl = document.getElementById("description");
    const trainBtn = document.getElementById("trainAndGenerateButton");
    const saveBtn = document.getElementById("saveSampleButton");
    const moodInput = document.getElementById("mood");
    const placeInput = document.getElementById("place");
    const historyList = document.getElementById("historyList");
    const loader = document.getElementById("loader");

    const moodMap = { chill: 0, active: 1, adventure: 2, relaxed: 3 };
    const placeMap = { river: 0, mountain: 1, quiet: 2, city: 3, beach: 4 };
    const locationMap = { south: 0, north: 1, central: 2 };
    const reverseLocationMap = { 0: 'Mi·ªÅn Nam', 1: 'Mi·ªÅn B·∫Øc', 2: 'Mi·ªÅn Trung' };

    let latestSample = null;

    function getLocalData() {
      const raw = localStorage.getItem('personalizedHistory');
      if (!raw) return [{ mood: "adventure", place: "mountain", location: "north" }];
      try {
        return JSON.parse(raw);
      } catch (e) {
        console.error("D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá:", e);
        return [{ mood: "adventure", place: "mountain", location: "north" }];
      }
    }

    function updateHistoryUI() {
      const history = getLocalData();
      historyList.innerHTML = history.length === 0
        ? '<li class="text-gray-500">Ch∆∞a c√≥ g·ª£i √Ω n√†o ƒë∆∞·ª£c l∆∞u.</li>'
        : history.map(item => `<li><strong class="text-green-600">${item.mood}</strong> - ${item.place} - ${item.location}</li>`).join('');
    }

    function prepareTensors(data) {
      const filtered = data.filter(item =>
        moodMap[item.mood] !== undefined &&
        placeMap[item.place] !== undefined &&
        locationMap[item.location] !== undefined
      );

      const inputs = filtered.map(d => [moodMap[d.mood], placeMap[d.place]]);
      const labels = filtered.map(d => {
        const oneHot = [0, 0, 0];
        oneHot[locationMap[d.location]] = 1;
        return oneHot;
      });

      return {
        X: tf.tensor2d(inputs),
        y: tf.tensor2d(labels)
      };
    }

    async function createModel() {
      const model = tf.sequential();
      model.add(tf.layers.dense({ inputShape: [2], units: 32, activation: 'relu' }));
      model.add(tf.layers.dense({ units: 16, activation: 'relu' }));
      model.add(tf.layers.dense({ units: 3, activation: 'softmax' }));
      model.compile({ optimizer: 'adam', loss: 'categoricalCrossentropy', metrics: ['accuracy'] });
      return model;
    }

    async function getServerWeights() {
      try {
        const res = await fetch('/get_weights');
        if (!res.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i tr·ªçng s·ªë.');
        const weights = await res.json();
        return weights.map(arr => tf.tensor(arr));
      } catch (e) {
        console.error("L·ªói t·∫£i tr·ªçng s·ªë:", e);
        return null;
      }
    }

    async function sendWeights(weights) {
      try {
        const plainWeights = await Promise.all(weights.map(w => w.array()));
        await fetch('/upload_weights', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ weights: plainWeights })
        });
      } catch (e) {
        console.error("L·ªói g·ª≠i tr·ªçng s·ªë:", e);
      }
    }

    function generateDescription(sample) {
      const { mood, place, location } = sample;

      const moodText = {
        chill: "m·ªôt t√¢m h·ªìn y√™u s·ª± y√™n b√¨nh, t√¨m ki·∫øm nh·ªØng kho·∫£nh kh·∫Øc th∆∞ th√°i gi·ªØa thi√™n nhi√™n v√† nh·ªãp s·ªëng ch·∫≠m r√£i",
        active: "m·ªôt ng∆∞·ªùi tr√†n ƒë·∫ßy nƒÉng l∆∞·ª£ng, lu√¥n s·∫µn s√†ng cho nh·ªØng tr·∫£i nghi·ªám s√¥i ƒë·ªông v√† nh·ªØng th·ª≠ th√°ch m·ªõi",
        adventure: "m·ªôt nh√† th√°m hi·ªÉm th·ª±c th·ª•, khao kh√°t chinh ph·ª•c nh·ªØng ƒë·ªânh cao v√† kh√°m ph√° nh·ªØng b√≠ ·∫©n c·ªßa ƒë·∫•t tr·ªùi",
        relaxed: "ng∆∞·ªùi s·ªëng ch·∫≠m, t·∫≠n h∆∞·ªüng t·ª´ng kho·∫£nh kh·∫Øc ƒë·ªùi th∆∞·ªùng trong s·ª± b√¨nh y√™n v√† nh·∫π nh√†ng"
      };

      const placeText = {
        river: "nh·ªØng d√≤ng s√¥ng l·∫•p l√°nh, n∆°i b·∫°n c√≥ th·ªÉ th·∫£ m√¨nh tr√™n thuy·ªÅn, ng·∫Øm c·∫£nh s·∫Øc thi√™n nhi√™n th∆° m·ªông",
        mountain: "nh·ªØng ng·ªçn n√∫i tr·∫≠p tr√πng, n∆°i m·ªói b∆∞·ªõc ch√¢n l√† m·ªôt l·∫ßn chinh ph·ª•c v√† h√≤a m√¨nh v√†o thi√™n nhi√™n h√πng vƒ©",
        quiet: "nh·ªØng v√πng qu√™ thanh b√¨nh, n∆°i ti·∫øng chim h√≥t v√† l√†n gi√≥ m√°t l√†nh xoa d·ªãu t√¢m h·ªìn",
        city: "nh·ªØng ƒë√¥ th·ªã r·ª±c r·ª° √°nh ƒë√®n, n∆°i nh·ªãp s·ªëng s√¥i ƒë·ªông h√≤a quy·ªán v·ªõi vƒÉn h√≥a v√† ·∫©m th·ª±c ƒëa d·∫°ng",
        beach: "nh·ªØng b√£i bi·ªÉn xanh ng·∫Øt, n∆°i s√≥ng v·ªó r√¨ r√†o v√† c√°t v√†ng l·∫•p l√°nh d∆∞·ªõi √°nh m·∫∑t tr·ªùi"
      };

      const destinationDetails = {
        'Mi·ªÅn B·∫Øc': {
          adventure: {
            mountain: `H√£y t∆∞·ªüng t∆∞·ª£ng b·∫°n ƒëang ƒë·ª©ng tr√™n **ƒë·ªânh Fansipan** ·ªü Sa Pa, n∆°i m√¢y m√π qu·∫•n qu√Ωt quanh nh·ªØng v√°ch ƒë√° v√† nh·ªØng th·ª≠a ru·ªông b·∫≠c thang tr·∫£i d√†i nh∆∞ m·ªôt b·ª©c tranh s·ªëng ƒë·ªông. H√≠t th·ªü kh√¥ng kh√≠ trong l√†nh, c·∫£m nh·∫≠n l√†n gi√≥ l·∫°nh bu·ªët, b·∫°n s·∫Ω th·∫•y m√¨nh nh∆∞ ch·∫°m ƒë·∫øn b·∫ßu tr·ªùi. N·∫øu b·∫°n mu·ªën m·ªôt h√†nh tr√¨nh kh·∫Øc nghi·ªát h∆°n, h√£y th·ª≠ cung ƒë∆∞·ªùng **H√† Giang** ‚Äì n∆°i nh·ªØng con ƒë√®o u·ªën l∆∞·ª£n nh∆∞ r·ªìng l∆∞·ª£n, d·∫´n b·∫°n qua nh·ªØng thung l≈©ng xanh m∆∞·ªõt v√† nh·ªØng c√°nh ƒë·ªìng hoa tam gi√°c m·∫°ch n·ªü r·ªô v√†o m√πa thu. D·ª´ng ch√¢n ·ªü **C·ªôt c·ªù L≈©ng C√∫**, ƒëi·ªÉm c·ª±c B·∫Øc c·ªßa T·ªï qu·ªëc, ƒë·ªÉ t·ª± h√†o ng·∫Øm nh√¨n ƒë·∫•t n∆∞·ªõc t·ª´ m·ªôt g√≥c nh√¨n ho√†n to√†n m·ªõi.

Ho·∫∑c, n·∫øu b·∫°n mu·ªën k·∫øt h·ª£p phi√™u l∆∞u v·ªõi vƒÉn h√≥a, h√£y gh√© **Mai Ch√¢u**, n∆°i nh·ªØng b·∫£n l√†ng ng∆∞·ªùi Th√°i n·∫±m n√©p m√¨nh gi·ªØa n√∫i r·ª´ng. Tham gia m·ªôt chuy·∫øn trekking qua nh·ªØng con ƒë∆∞·ªùng m√≤n, ng·ªß trong nh·ªØng ng√¥i nh√† s√†n truy·ªÅn th·ªëng, v√† th∆∞·ªüng th·ª©c m√≥n c∆°m lam th∆°m l·ª´ng b√™n b·∫øp l·ª≠a. M·ªói kho·∫£nh kh·∫Øc ·ªü ƒë√¢y l√† m·ªôt c√¢u chuy·ªán, m·ªôt k·ª∑ ni·ªám m√† b·∫°n s·∫Ω mang theo m√£i m√£i.

H√£y chu·∫©n b·ªã ba l√¥, ƒë√¥i gi√†y leo n√∫i, v√† m·ªôt tr√°i tim r·ªông m·ªü. Mi·ªÅn B·∫Øc ƒëang ch·ªù b·∫°n v·ªõi nh·ªØng ch√¢n tr·ªùi m·ªõi, nh·ªØng th·ª≠ th√°ch m·ªõi, v√† nh·ªØng tr·∫£i nghi·ªám ƒë∆∞·ª£c thi·∫øt k·∫ø ri√™ng cho tinh th·∫ßn phi√™u l∆∞u c·ªßa b·∫°n!`
          },
          chill: {
            river: `H√£y th·∫£ h·ªìn tr√™n d√≤ng **s√¥ng L√¥** ·ªü Tuy√™n Quang, n∆°i b·∫°n c√≥ th·ªÉ ng·ªìi tr√™n chi·∫øc thuy·ªÅn nh·ªè, l∆∞·ªõt nh·∫π qua nh·ªØng d√£y n√∫i ƒë√° v√¥i h√πng vƒ© v√† nh·ªØng c√°nh ƒë·ªìng l√∫a xanh m∆∞·ªõt. √Ånh n·∫Øng d·ªãu nh·∫π ph·∫£n chi·∫øu tr√™n m·∫∑t n∆∞·ªõc, h√≤a quy·ªán v·ªõi ti·∫øng chim h√≥t l√≠u lo, t·∫°o n√™n m·ªôt b·∫£n giao h∆∞·ªüng c·ªßa thi√™n nhi√™n. Gh√© thƒÉm **th√°c B·∫£n Gi·ªëc** ·ªü Cao B·∫±ng, m·ªôt trong nh·ªØng th√°c n∆∞·ªõc ƒë·∫πp nh·∫•t Vi·ªát Nam, n∆°i b·∫°n c√≥ th·ªÉ ng·ªìi b√™n d√≤ng n∆∞·ªõc m√°t l√†nh, nh√¢m nhi m·ªôt t√°ch tr√† v√† ƒë·ªÉ m·ªçi lo toan tan bi·∫øn.

N·∫øu b·∫°n mu·ªën tr·∫£i nghi·ªám vƒÉn h√≥a s√¥ng n∆∞·ªõc, h√£y ƒë·∫øn **Ninh B√¨nh**, n∆°i ƒë∆∞·ª£c m·ªánh danh l√† ‚ÄúV·ªãnh H·∫° Long tr√™n c·∫°n‚Äù. Ch√®o thuy·ªÅn qua **Tam C·ªëc** ho·∫∑c **Tr√†ng An**, b·∫°n s·∫Ω b·ªã m√™ ho·∫∑c b·ªüi nh·ªØng hang ƒë·ªông k·ª≥ b√≠ v√† nh·ªØng ng√¥i ch√πa c·ªï k√≠nh n√©p m√¨nh b√™n d√≤ng s√¥ng. Bu·ªïi t·ªëi, th∆∞·ªüng th·ª©c m√≥n **d√™ n√∫i** ƒë·∫∑c s·∫£n v√† nghe nh·ªØng c√¢u h√°t d√¢n ca Quan H·ªç ng·ªçt ng√†o b√™n b·ªù s√¥ng.

Mi·ªÅn B·∫Øc l√† n∆°i ƒë·ªÉ b·∫°n t√¨m l·∫°i s·ª± tƒ©nh l·∫∑ng trong t√¢m h·ªìn. H√£y mang theo m·ªôt cu·ªën s√°ch y√™u th√≠ch, m·ªôt chi·∫øc m√°y ·∫£nh, v√† s·∫µn s√†ng ƒë·ªÉ ghi l·∫°i nh·ªØng kho·∫£nh kh·∫Øc y√™n b√¨nh. D√≤ng s√¥ng c·ªßa Mi·ªÅn B·∫Øc ƒëang ch·ªù b·∫°n kh√°m ph√°, mang ƒë·∫øn nh·ªØng k·ª∑ ni·ªám nh·∫π nh√†ng nh∆∞ng s√¢u s·∫Øc, ƒë√∫ng nh∆∞ c√°ch b·∫°n y√™u th√≠ch!`
          }
        },
        'Mi·ªÅn Trung': {
          active: {
            city: `Kh√°m ph√° **ƒê√† N·∫µng**, th√†nh ph·ªë c·ªßa nh·ªØng c√¢y c·∫ßu ƒë·ªôc ƒë√°o v√† nh·ªãp s·ªëng hi·ªán ƒë·∫°i. ƒê·ª´ng b·ªè qua **c·∫ßu R·ªìng** phun l·ª≠a v√†o cu·ªëi tu·∫ßn, hay m·ªôt bu·ªïi t·ªëi d·∫°o quanh **ph·ªë c·ªï H·ªôi An** v·ªõi nh·ªØng chi·∫øc ƒë√®n l·ªìng lung linh. Th∆∞·ªüng th·ª©c m√≥n **m√¨ Qu·∫£ng** ch√≠nh g·ªëc ƒë·ªÉ n·∫°p nƒÉng l∆∞·ª£ng cho h√†nh tr√¨nh c·ªßa b·∫°n!

Ti·∫øp t·ª•c h√†nh tr√¨nh ƒë·∫øn **Hu·∫ø**, n∆°i b·∫°n c√≥ th·ªÉ ƒë·∫°p xe qua nh·ªØng con ƒë∆∞·ªùng r·ª£p b√≥ng c√¢y, gh√© thƒÉm **ƒê·∫°i N·ªôi** ƒë·ªÉ c·∫£m nh·∫≠n h∆°i th·ªü l·ªãch s·ª≠, ho·∫∑c tham gia m·ªôt l·ªõp h·ªçc n·∫•u ƒÉn ƒë·ªÉ t·ª± tay l√†m m√≥n **b√∫n b√≤ Hu·∫ø**. Bu·ªïi t·ªëi, h√£y l√™n thuy·ªÅn tr√™n **s√¥ng H∆∞∆°ng**, nghe ca Hu·∫ø v√† th·∫£ ƒë√®n hoa ƒëƒÉng c·∫ßu may m·∫Øn.

Mi·ªÅn Trung l√† s√¢n ch∆°i c·ªßa nh·ªØng t√¢m h·ªìn nƒÉng ƒë·ªông. H√£y chu·∫©n b·ªã m·ªôt ƒë√¥i gi√†y tho·∫£i m√°i, m·ªôt chi·∫øc m≈© l∆∞·ª°i trai, and s·∫µn s√†ng h√≤a m√¨nh v√†o nh·ªãp s·ªëng s√¥i ƒë·ªông c·ªßa v√πng ƒë·∫•t n√†y!`
          }
        },
        'Mi·ªÅn Nam': {
          chill: {
            beach: `H√£y ƒë·∫øn v·ªõi **Ph√∫ Qu·ªëc**, thi√™n ƒë∆∞·ªùng bi·ªÉn v·ªõi nh·ªØng b√£i c√°t tr·∫Øng m·ªãn v√† ho√†ng h√¥n r·ª±c r·ª°. Th∆∞ gi√£n tr√™n **b√£i Sao**, nh√¢m nhi n∆∞·ªõc d·ª´a t∆∞∆°i, ho·∫∑c l·∫∑n ng·∫Øm san h√¥ ·ªü **H√≤n Th∆°m**. M·ªôt chuy·∫øn ƒëi ch·ª£ ƒë√™m Ph√∫ Qu·ªëc ƒë·ªÉ th∆∞·ªüng th·ª©c h·∫£i s·∫£n t∆∞∆°i ngon s·∫Ω l√† ƒëi·ªÉm nh·∫•n cho k·ª≥ ngh·ªâ c·ªßa b·∫°n.

N·∫øu b·∫°n mu·ªën s·ª± y√™n tƒ©nh h∆°n, h√£y gh√© **C√¥n ƒê·∫£o**, n∆°i nh·ªØng b√£i bi·ªÉn hoang s∆° nh∆∞ **b√£i ƒê·∫ßm Tr·∫ßu** mang ƒë·∫øn c·∫£m gi√°c nh∆∞ l·∫°c v√†o m·ªôt th·∫ø gi·ªõi ri√™ng. ƒêi d·∫°o d∆∞·ªõi nh·ªØng h√†ng c√¢y b√†ng c·ªï th·ª•, kh√°m ph√° l·ªãch s·ª≠ t·∫°i nh√† t√π C√¥n ƒê·∫£o, ho·∫∑c ƒë∆°n gi·∫£n l√† n·∫±m d√†i tr√™n b√£i bi·ªÉn, nghe ti·∫øng s√≥ng v·ªó.

Mi·ªÅn Nam l√† n∆°i ƒë·ªÉ b·∫°n th·∫£ l·ªèng v√† t·∫≠n h∆∞·ªüng. Mang theo m·ªôt chi·∫øc v√µng, m·ªôt playlist nh·∫°c y√™u th√≠ch, v√† ƒë·ªÉ bi·ªÉn c·∫£ xoa d·ªãu t√¢m h·ªìn b·∫°n!`
          }
        }
      };

      const baseDescription = `D·ª±a tr√™n nh·ªØng h√†nh tr√¨nh tr∆∞·ªõc ƒë√¢y, ch√∫ng t√¥i nh·∫≠n th·∫•y b·∫°n l√† ${moodText[mood]}. Nh·ªØng ƒë·ªãa ƒëi·ªÉm nh∆∞ ${placeText[place]} ch√≠nh l√† n∆°i tr√°i tim b·∫°n thu·ªôc v·ªÅ. V·ªõi tinh th·∫ßn v√† s·ªü th√≠ch ƒë·ªôc ƒë√°o c·ªßa b·∫°n, **${location}** l√† ƒëi·ªÉm ƒë·∫øn l√Ω t∆∞·ªüng ƒë·ªÉ b·∫°n ti·∫øp t·ª•c vi·∫øt n√™n c√¢u chuy·ªán du l·ªãch c·ªßa m√¨nh!`;

      const specificDetails = destinationDetails[location]?.[mood]?.[place] || `Kh√°m ph√° ${location} ƒë·ªÉ t√¨m th·∫•y nh·ªØng tr·∫£i nghi·ªám ph√π h·ª£p v·ªõi c√° t√≠nh c·ªßa b·∫°n. H√£y chu·∫©n b·ªã h√†nh trang v√† b·∫Øt ƒë·∫ßu chuy·∫øn ƒëi ƒë·ªÉ t·∫°o n√™n nh·ªØng k·ª∑ ni·ªám kh√¥ng th·ªÉ n√†o qu√™n!`;

      const history = getLocalData();
      const hasAdventureHistory = history.some(item => item.mood === 'adventure' && item.place === 'mountain' && item.location === 'north');
      const adventureNote = hasAdventureHistory && mood !== 'adventure'
        ? `\n\nCh√∫ng t√¥i c≈©ng nh·∫≠n th·∫•y b·∫°n t·ª´ng y√™u th√≠ch nh·ªØng chuy·∫øn phi√™u l∆∞u tr√™n n√∫i ·ªü Mi·ªÅn B·∫Øc. N·∫øu mu·ªën th√™m ch√∫t th·ª≠ th√°ch, b·∫°n c√≥ th·ªÉ k·∫øt h·ª£p chuy·∫øn ƒëi n√†y v·ªõi m·ªôt h√†nh tr√¨nh trekking nh·∫π nh√†ng ho·∫∑c kh√°m ph√° nh·ªØng cung ƒë∆∞·ªùng ƒë√®o tuy·ªát ƒë·∫πp!`
        : '';

      return `${baseDescription}\n\n${specificDetails}${adventureNote}`;
    }

    async function generateSampleFromModel(model, localData, userInput) {
      const { X, y } = prepareTensors(localData);
      await model.fit(X, y, { epochs: 20, verbose: 0 });

      const input = tf.tensor2d([[moodMap[userInput.mood], placeMap[userInput.place]]]);
      const prediction = model.predict(input);
      const predictedIndex = prediction.argMax(-1).dataSync()[0];

      return {
        mood: userInput.mood,
        place: userInput.place,
        location: reverseLocationMap[predictedIndex]
      };
    }

    async function runFlow() {
      statusEl.textContent = "ƒêang ph√¢n t√≠ch s·ªü th√≠ch c·ªßa b·∫°n...";
      loader.classList.remove('hidden');

      const localData = getLocalData();
      if (localData.length === 0) {
        statusEl.textContent = "B·∫°n ch∆∞a c√≥ d·ªØ li·ªáu l·ªãch s·ª≠. H√£y ch·ªçn s·ªü th√≠ch v√† t·∫°o g·ª£i √Ω m·ªõi!";
        loader.classList.add('hidden');
        return;
      }

      const userInput = {
        mood: moodInput.value || localData[0].mood,
        place: placeInput.value || localData[0].place
      };

      const model = await createModel();
      const serverWeights = await getServerWeights();
      if (serverWeights) model.setWeights(serverWeights);

      try {
        const newSample = await generateSampleFromModel(model, localData, userInput);
        latestSample = newSample;

        resultEl.textContent = `T√¢m tr·∫°ng: ${newSample.mood} | ƒê·ªãa ƒëi·ªÉm y√™u th√≠ch: ${newSample.place} | ƒêi·ªÉm ƒë·∫øn g·ª£i √Ω: ${newSample.location}`;
        descEl.textContent = generateDescription(newSample);
        statusEl.textContent = "G·ª£i √Ω c√° nh√¢n h√≥a ƒë√£ s·∫µn s√†ng!";
        await sendWeights(model.getWeights());
      } catch (e) {
        statusEl.textContent = "C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!";
        console.error("L·ªói:",e);
      } finally {
        loader.classList.add('hidden');
      }
    }

    trainBtn.addEventListener("click", runFlow);

    saveBtn.addEventListener("click", () => {
        
      if (!latestSample) return alert("Kh√¥ng c√≥ g·ª£i √Ω n√†o ƒë·ªÉ l∆∞u. H√£y t·∫°o g·ª£i √Ω m·ªõi!");
      const history = getLocalData();
      history.push({
        mood: latestSample.mood,
        place: latestSample.place,
        location: latestSample.location
      });
      localStorage.setItem('personalizedHistory', JSON.stringify(history));
      updateHistoryUI();
      console.log("L∆∞u g·ª£i √Ω v√†o l·ªãch s·ª≠:", latestSample);
      alert("ƒê√£ l∆∞u g·ª£i √Ω v√†o l·ªãch s·ª≠!");
    });

    window.addEventListener("load", () => {
      updateHistoryUI();
      runFlow();
    });
  </script>
</body>
</html>